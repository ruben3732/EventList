<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ChronoSync ‚Äî Smart Schedule Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Epilogue:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07080f;--surface:#0e0f1a;--surface2:#161728;--surface3:#1e2035;
  --border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.12);
  --accent:#6366f1;--accent2:#f472b6;--accent3:#34d399;--accent4:#fbbf24;
  --text:#eeeef5;--text-muted:#7878a0;--text-dim:#4a4a6a;
  --success:#34d399;--warning:#fbbf24;--danger:#f87171;
  --radius:14px;--radius-sm:8px;--radius-lg:20px;
  --shadow:0 8px 32px rgba(0,0,0,0.6);
  --sidebar-w:260px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Epilogue',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;top:-30%;left:-20%;width:70%;height:70%;background:radial-gradient(ellipse,rgba(99,102,241,0.07) 0%,transparent 65%);pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;bottom:-20%;right:-10%;width:50%;height:50%;background:radial-gradient(ellipse,rgba(244,114,182,0.05) 0%,transparent 65%);pointer-events:none;z-index:0;}

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px;}

/* ‚îÄ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ‚îÄ */
#authScreen{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:20px;}
.auth-card{width:100%;max-width:440px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius-lg);padding:48px 40px;position:relative;overflow:hidden;}
.auth-card::before{content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:radial-gradient(circle,rgba(99,102,241,0.15),transparent 70%);pointer-events:none;}
.auth-logo{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;background:linear-gradient(135deg,#6366f1,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;}
.auth-tagline{color:var(--text-muted);font-size:14px;margin-bottom:36px;}
.auth-tabs{display:flex;gap:4px;background:var(--surface2);border-radius:var(--radius-sm);padding:4px;margin-bottom:28px;}
.auth-tab{flex:1;padding:10px;text-align:center;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-muted);transition:all .2s;}
.auth-tab.active{background:var(--accent);color:#fff;}
.form-group{margin-bottom:16px;}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;}
.form-input{width:100%;padding:13px 16px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-family:'Epilogue',sans-serif;font-size:15px;outline:none;transition:border-color .2s;}
.form-input:focus{border-color:var(--accent);}
.form-input::placeholder{color:var(--text-dim);}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:13px 24px;border-radius:var(--radius-sm);border:none;cursor:pointer;font-family:'Epilogue',sans-serif;font-size:15px;font-weight:600;transition:all .2s;text-decoration:none;}
.btn-primary{background:var(--accent);color:#fff;width:100%;}
.btn-primary:hover{background:#5254cc;transform:translateY(-1px);}
.btn-google{background:var(--surface2);color:var(--text);border:1px solid var(--border2);width:100%;margin-top:12px;}
.btn-google:hover{border-color:var(--border2);background:var(--surface3);}
.btn-ghost{background:transparent;color:var(--text-muted);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:rgba(248,113,113,0.15);color:var(--danger);border:1px solid rgba(248,113,113,0.3);}
.btn-danger:hover{background:rgba(248,113,113,0.25);}
.btn-sm{padding:8px 16px;font-size:13px;}
.btn-xs{padding:5px 10px;font-size:12px;}
.auth-divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:var(--text-dim);font-size:13px;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.auth-error{background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);border-radius:var(--radius-sm);padding:10px 14px;font-size:13px;color:var(--danger);margin-bottom:16px;display:none;}

/* ‚îÄ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ‚îÄ */
#app{display:none;height:100vh;overflow:hidden;}
.layout{display:flex;height:100vh;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;position:relative;z-index:10;transition:transform .3s;}
.sidebar-header{padding:24px 20px 20px;border-bottom:1px solid var(--border);}
.logo{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;background:linear-gradient(135deg,#6366f1,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.logo-sub{font-size:11px;color:var(--text-dim);letter-spacing:.08em;text-transform:uppercase;margin-top:2px;}
.user-pill{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface2);border-radius:var(--radius-sm);margin-top:14px;}
.user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
.user-info{flex:1;min-width:0;}
.user-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-role{font-size:11px;color:var(--text-muted);}
.sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto;}
.nav-section{font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em;padding:0 8px;margin-bottom:8px;margin-top:20px;}
.nav-section:first-child{margin-top:0;}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 12px;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;color:var(--text-muted);font-size:14px;font-weight:500;position:relative;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(99,102,241,0.12);color:var(--accent);}
.nav-item.active::before{content:'';position:absolute;left:0;top:25%;bottom:25%;width:3px;background:var(--accent);border-radius:0 3px 3px 0;}
.nav-icon{font-size:18px;width:24px;text-align:center;}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;}
.sidebar-footer{padding:16px 12px;border-top:1px solid var(--border);}
.gcal-btn{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--radius-sm);cursor:pointer;background:var(--surface2);border:1px solid var(--border);transition:all .2s;font-size:13px;font-weight:500;color:var(--text-muted);width:100%;}
.gcal-btn:hover{border-color:var(--accent);color:var(--accent);}
.gcal-btn.connected{background:rgba(52,211,153,0.08);border-color:rgba(52,211,153,0.3);color:var(--success);}
.sign-out-btn{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--radius-sm);cursor:pointer;color:var(--text-dim);font-size:13px;transition:all .2s;width:100%;margin-top:8px;background:none;border:none;}
.sign-out-btn:hover{color:var(--danger);}

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.topbar{padding:0 28px;height:64px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;gap:16px;}
.topbar-left{display:flex;align-items:center;gap:16px;}
.hamburger{display:none;background:none;border:none;cursor:pointer;padding:8px;color:var(--text);font-size:20px;}
.page-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;}
.topbar-right{display:flex;align-items:center;gap:12px;}
.topbar-date{font-size:13px;color:var(--text-muted);}
.content{flex:1;overflow-y:auto;padding:28px;}

/* ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ */
.view{display:none;}
.view.active{display:block;}

/* ‚îÄ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:28px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px 20px;position:relative;overflow:hidden;}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent-color,var(--accent));}
.stat-num{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;color:var(--accent-color,var(--accent));line-height:1;}
.stat-label{font-size:13px;color:var(--text-muted);margin-top:6px;}
.stat-sub{font-size:11px;color:var(--text-dim);margin-top:4px;}

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;}
.card-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:20px;}

/* ‚îÄ‚îÄ‚îÄ EVENT CARDS ‚îÄ‚îÄ‚îÄ */
.event-item{display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);}
.event-item:last-child{border-bottom:none;}
.event-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.event-info{flex:1;min-width:0;}
.event-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.event-meta{font-size:12px;color:var(--text-muted);margin-top:2px;}
.event-tag{font-size:11px;padding:3px 9px;border-radius:20px;font-weight:600;}
.tag-meeting{background:rgba(99,102,241,0.15);color:#818cf8;}
.tag-deadline{background:rgba(248,113,113,0.15);color:#f87171;}
.tag-personal{background:rgba(52,211,153,0.15);color:#34d399;}
.tag-reminder{background:rgba(251,191,36,0.15);color:#fbbf24;}
.tag-focus{background:rgba(244,114,182,0.15);color:#f472b6;}

/* ‚îÄ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.cal-nav{display:flex;align-items:center;gap:12px;}
.cal-nav button{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:var(--radius-sm);cursor:pointer;font-size:14px;transition:all .2s;}
.cal-nav button:hover{border-color:var(--accent);}
.cal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;}
.cal-view-tabs{display:flex;gap:4px;background:var(--surface2);border-radius:var(--radius-sm);padding:3px;}
.cal-view-tab{padding:7px 16px;border-radius:5px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text-muted);transition:all .2s;}
.cal-view-tab.active{background:var(--accent);color:#fff;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);}
.cal-day-header{background:var(--surface);text-align:center;padding:10px 4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-muted);}
.cal-day{background:var(--surface);min-height:90px;padding:8px;cursor:pointer;transition:background .15s;position:relative;}
.cal-day:hover{background:var(--surface2);}
.cal-day.other-month .day-num{color:var(--text-dim);}
.cal-day.today{background:rgba(99,102,241,0.08);}
.cal-day.today .day-num{background:var(--accent);color:#fff;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;}
.day-num{font-size:13px;font-weight:600;margin-bottom:4px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;}
.cal-event-chip{font-size:11px;padding:2px 6px;border-radius:4px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;}
.more-events{font-size:10px;color:var(--text-muted);padding:2px 4px;}

/* ‚îÄ‚îÄ‚îÄ EVENTS LIST ‚îÄ‚îÄ‚îÄ */
.events-toolbar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
.search-input{flex:1;min-width:200px;padding:11px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'Epilogue',sans-serif;font-size:14px;outline:none;}
.search-input:focus{border-color:var(--accent);}
.filter-select{padding:11px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'Epilogue',sans-serif;font-size:14px;outline:none;cursor:pointer;}
.event-row{display:flex;align-items:center;gap:14px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;transition:border-color .2s;cursor:pointer;}
.event-row:hover{border-color:var(--border2);}
.event-row-date{text-align:center;min-width:48px;}
.event-row-date .day{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;line-height:1;}
.event-row-date .mon{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;}
.event-row-divider{width:1px;height:40px;background:var(--border);}
.event-row-info{flex:1;min-width:0;}
.event-row-title{font-size:15px;font-weight:600;}
.event-row-meta{font-size:12px;color:var(--text-muted);margin-top:3px;display:flex;gap:12px;flex-wrap:wrap;}
.event-row-actions{display:flex;gap:8px;flex-shrink:0;}

/* ‚îÄ‚îÄ‚îÄ MINI CALENDAR ‚îÄ‚îÄ‚îÄ */
.mini-cal{padding:0 8px 16px;}
.mini-cal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 4px 10px;font-size:13px;font-weight:600;}
.mini-cal-nav{background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px;padding:4px 8px;border-radius:4px;}
.mini-cal-nav:hover{color:var(--text);}
.mini-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.mini-cal-dh{text-align:center;font-size:10px;color:var(--text-dim);padding:4px 0;font-weight:600;}
.mini-cal-d{text-align:center;font-size:12px;padding:5px 2px;border-radius:6px;cursor:pointer;transition:background .15s;color:var(--text-muted);}
.mini-cal-d:hover{background:var(--surface2);}
.mini-cal-d.today{background:var(--accent);color:#fff;font-weight:700;}
.mini-cal-d.has-events{color:var(--text);font-weight:600;}
.mini-cal-d.other{color:var(--text-dim);}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius-lg);width:100%;max-width:540px;max-height:90vh;overflow-y:auto;position:relative;}
.modal-header{padding:24px 28px 0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;padding-bottom:20px;border-bottom:1px solid var(--border);}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;}
.modal-close{background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:22px;line-height:1;padding:4px;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:24px 28px 28px;}
.modal-footer{padding:0 28px 24px;display:flex;gap:10px;justify-content:flex-end;}

/* ‚îÄ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ‚îÄ */
.field-group{margin-bottom:18px;}
.field-label{display:block;font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;}
.field-input{width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'Epilogue',sans-serif;font-size:14px;outline:none;transition:border-color .2s;}
.field-input:focus{border-color:var(--accent);}
.field-input::placeholder{color:var(--text-dim);}
select.field-input{cursor:pointer;}
textarea.field-input{resize:vertical;min-height:80px;}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.color-row{display:flex;gap:8px;flex-wrap:wrap;}
.color-dot{width:28px;height:28px;border-radius:50%;cursor:pointer;transition:transform .15s;border:2px solid transparent;}
.color-dot:hover{transform:scale(1.2);}
.color-dot.selected{border-color:#fff;transform:scale(1.15);}

/* ‚îÄ‚îÄ‚îÄ ADMIN DASHBOARD ‚îÄ‚îÄ‚îÄ */
.admin-badge{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;letter-spacing:.05em;}
.user-table{width:100%;border-collapse:collapse;}
.user-table th{text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;padding:10px 14px;border-bottom:1px solid var(--border);}
.user-table td{padding:14px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle;}
.user-table tr:last-child td{border-bottom:none;}
.user-table tr:hover td{background:var(--surface2);}
.status-dot{display:inline-flex;width:8px;height:8px;border-radius:50%;margin-right:6px;}
.status-active{background:var(--success);}
.status-banned{background:var(--danger);}

/* ‚îÄ‚îÄ‚îÄ BOOKING PAGE ‚îÄ‚îÄ‚îÄ */
#bookingScreen{position:fixed;inset:0;z-index:900;display:none;background:var(--bg);overflow-y:auto;}
.booking-wrap{max-width:900px;margin:0 auto;padding:40px 20px;}
.booking-header{text-align:center;margin-bottom:40px;}
.booking-host{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;}
.booking-avatar{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#fff;}
.booking-host-name{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;}
.booking-host-title{font-size:14px;color:var(--text-muted);margin-top:4px;}
.booking-layout{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
.booking-cal-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;}
.booking-slots{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;}
.slot-date-header{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:16px;}
.slot-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.slot-btn{padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;font-family:'Epilogue',sans-serif;font-size:13px;font-weight:500;color:var(--text);transition:all .2s;text-align:center;}
.slot-btn:hover{border-color:var(--accent);color:var(--accent);}
.slot-btn.selected{background:rgba(99,102,241,0.15);border-color:var(--accent);color:var(--accent);}
.slot-btn.booked{opacity:.4;cursor:not-allowed;text-decoration:line-through;}
.booking-form-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;margin-top:20px;}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
#toastContainer{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{padding:14px 20px;border-radius:var(--radius-sm);font-size:14px;font-weight:500;min-width:280px;max-width:380px;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px;pointer-events:all;animation:slideIn .3s ease;}
.toast-success{background:#0f2a1e;border:1px solid rgba(52,211,153,0.4);color:var(--success);}
.toast-error{background:#2a0f0f;border:1px solid rgba(248,113,113,0.4);color:var(--danger);}
.toast-info{background:var(--surface2);border:1px solid var(--border2);color:var(--text);}
@keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}

/* ‚îÄ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ‚îÄ */
.detail-panel{position:fixed;right:0;top:0;bottom:0;width:360px;background:var(--surface);border-left:1px solid var(--border);z-index:200;transform:translateX(100%);transition:transform .3s;overflow-y:auto;padding:28px;}
.detail-panel.open{transform:translateX(0);}
.detail-close{position:absolute;top:20px;right:20px;background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:22px;}
.detail-close:hover{color:var(--text);}

/* ‚îÄ‚îÄ‚îÄ SHARE MODAL SPECIFICS ‚îÄ‚îÄ‚îÄ */
.share-link-box{display:flex;gap:8px;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text-muted);word-break:break-all;}
.availability-slot{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.availability-slot:last-child{border-bottom:none;}
.day-toggle{display:flex;align-items:center;gap:10px;padding:8px 0;}
.toggle{width:42px;height:24px;background:var(--surface3);border-radius:12px;cursor:pointer;position:relative;transition:background .2s;border:none;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .2s;}
.toggle.on::after{transform:translateX(18px);}

/* ‚îÄ‚îÄ‚îÄ MOBILE OVERLAY ‚îÄ‚îÄ‚îÄ */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9;}

/* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:60px auto;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty{text-align:center;padding:60px 20px;color:var(--text-muted);}
.empty-icon{font-size:48px;margin-bottom:16px;}
.empty h3{font-family:'Syne',sans-serif;font-size:18px;color:var(--text);margin-bottom:8px;}
.empty p{font-size:14px;}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width:768px){
  :root{--sidebar-w:280px;}
  .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:100;transform:translateX(-100%);}
  .sidebar.mobile-open{transform:translateX(0);}
  .sidebar-overlay{display:block;}
  .hamburger{display:flex;}
  .content{padding:16px;}
  .topbar{padding:0 16px;}
  .two-col,.three-col{grid-template-columns:1fr;}
  .stats-grid{grid-template-columns:1fr 1fr;}
  .booking-layout{grid-template-columns:1fr;}
  .field-row{grid-template-columns:1fr;}
  .detail-panel{width:100%;}
  .topbar-date{display:none;}
  .user-table{font-size:12px;}
  .user-table th,.user-table td{padding:10px 8px;}
  .slot-grid{grid-template-columns:1fr 1fr;}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr;}
  .auth-card{padding:32px 24px;}
  .slot-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">ChronoSync</div>
    <div class="auth-tagline">Smart schedule management for everyone</div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">Create Account</div>
    </div>
    <div class="auth-error" id="authError"></div>
    <div id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" class="form-input" id="loginEmail" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-primary" onclick="signIn()">Sign In</button>
      <div class="auth-divider">or</div>
      <button class="btn btn-google" onclick="signInGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/></svg>
        Continue with Google
      </button>
    </div>
    <div id="registerForm" style="display:none">
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" class="form-input" id="regName" placeholder="Your name">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" class="form-input" id="regEmail" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" class="form-input" id="regPassword" placeholder="Min 6 characters">
      </div>
      <button class="btn btn-primary" onclick="register()">Create Account</button>
      <div class="auth-divider">or</div>
      <button class="btn btn-google" onclick="signInGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/></svg>
        Continue with Google
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê BOOKING SCREEN ‚ïê‚ïê‚ïê -->
<div id="bookingScreen">
  <div class="booking-wrap">
    <div class="booking-header">
      <div class="booking-host">
        <div class="booking-avatar" id="bookingAvatar">R</div>
        <div>
          <div class="booking-host-name" id="bookingHostName">Loading...</div>
          <div class="booking-host-title" id="bookingHostTitle">Schedule a meeting</div>
        </div>
      </div>
      <p style="color:var(--text-muted);font-size:14px;">Select a date and time that works for you</p>
    </div>
    <div class="booking-layout">
      <div class="booking-cal-section">
        <div class="card-title">Pick a Date</div>
        <div id="bookingMiniCal"></div>
      </div>
      <div class="booking-slots">
        <div class="slot-date-header" id="slotDateHeader">Select a date to see available times</div>
        <div class="slot-grid" id="slotGrid"><div class="empty" style="padding:20px"><p>‚Üê Pick a date first</p></div></div>
      </div>
    </div>
    <div class="booking-form-section" id="bookingFormSection" style="display:none">
      <div class="card-title">Your Details</div>
      <div class="field-row">
        <div class="field-group">
          <label class="field-label">Your Name</label>
          <input type="text" class="field-input" id="bookerName" placeholder="Full name">
        </div>
        <div class="field-group">
          <label class="field-label">Your Email</label>
          <input type="email" class="field-input" id="bookerEmail" placeholder="your@email.com">
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">What's this about?</label>
        <textarea class="field-input" id="bookerReason" placeholder="Brief description of the meeting topic..."></textarea>
      </div>
      <button class="btn btn-primary" onclick="confirmBooking()" style="width:100%">Confirm Booking</button>
    </div>
    <div id="bookingConfirmed" style="display:none;text-align:center;padding:60px 20px;">
      <div style="font-size:64px;margin-bottom:20px;">üéâ</div>
      <h2 style="font-family:'Syne',sans-serif;font-size:28px;margin-bottom:12px;">Booking Confirmed!</h2>
      <p style="color:var(--text-muted);font-size:15px;" id="confirmMsg"></p>
      <p style="color:var(--text-muted);font-size:13px;margin-top:12px;">A confirmation has been noted. The host will be notified.</p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê -->
<div id="app">
  <div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">ChronoSync</div>
        <div class="logo-sub">Smart Schedule Planner</div>
        <div class="user-pill">
          <div class="user-avatar" id="sidebarAvatar">?</div>
          <div class="user-info">
            <div class="user-name" id="sidebarName">Loading...</div>
            <div class="user-role" id="sidebarRole">Member</div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">Workspace</div>
        <div class="nav-item active" onclick="showView('dashboard')" id="nav-dashboard">
          <span class="nav-icon">‚ö°</span> Dashboard
        </div>
        <div class="nav-item" onclick="showView('calendar')" id="nav-calendar">
          <span class="nav-icon">üìÖ</span> Calendar
        </div>
        <div class="nav-item" onclick="showView('events')" id="nav-events">
          <span class="nav-icon">üìã</span> All Events
        </div>
        <div class="nav-item" onclick="showView('planner')" id="nav-planner">
          <span class="nav-icon">ü§ñ</span> AI Planner
        </div>
        <div class="nav-section">Share</div>
        <div class="nav-item" onclick="openShareModal()">
          <span class="nav-icon">üîó</span> Booking Link
        </div>
        <div class="nav-section" id="adminNavSection" style="display:none">Admin</div>
        <div class="nav-item" onclick="showView('admin')" id="nav-admin" style="display:none">
          <span class="nav-icon">üëë</span> Admin Dashboard
        </div>
        <div class="nav-section">Settings</div>
        <div class="nav-item" onclick="showView('settings')" id="nav-settings">
          <span class="nav-icon">‚öôÔ∏è</span> Settings
        </div>
        <div id="miniCalContainer"></div>
      </nav>
      <div class="sidebar-footer">
        <button class="gcal-btn" onclick="handleGoogleAuth()" id="gcalBtn">
          <span>üìÜ</span>
          <span id="gcalBtnText">Connect Google Calendar</span>
        </button>
        <button class="sign-out-btn" onclick="signOut()">
          <span>üö™</span> Sign out
        </button>
      </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- MAIN -->
    <div class="main">
      <div class="topbar">
        <div class="topbar-left">
          <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
          <div class="page-title" id="pageTitle">Dashboard</div>
        </div>
        <div class="topbar-right">
          <div class="topbar-date" id="topbarDate"></div>
          <button class="btn btn-primary btn-sm" onclick="openNewEvent()">+ New Event</button>
        </div>
      </div>
      <div class="content">

        <!-- DASHBOARD -->
        <div class="view active" id="view-dashboard">
          <div class="stats-grid" id="dashStats"></div>
          <div class="two-col">
            <div class="card">
              <div class="card-title">Today's Schedule <span style="font-size:13px;color:var(--text-muted);font-weight:400" id="todayLabel"></span></div>
              <div id="todayEvents"></div>
            </div>
            <div class="card">
              <div class="card-title">Upcoming Events</div>
              <div id="upcomingEvents"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Recent Bookings <span style="font-size:13px;font-weight:400;color:var(--text-muted)">‚Äî meetings others booked with you</span></div>
            <div id="recentBookings"></div>
          </div>
        </div>

        <!-- CALENDAR -->
        <div class="view" id="view-calendar">
          <div class="card">
            <div class="cal-header">
              <div class="cal-nav">
                <button onclick="calNav(-1)">‚Üê</button>
                <span class="cal-title" id="calTitle"></span>
                <button onclick="calNav(1)">‚Üí</button>
              </div>
              <div class="cal-view-tabs">
                <div class="cal-view-tab active" onclick="setCalView('month',this)">Month</div>
                <div class="cal-view-tab" onclick="setCalView('week',this)">Week</div>
              </div>
            </div>
            <div id="calContainer"></div>
          </div>
        </div>

        <!-- EVENTS -->
        <div class="view" id="view-events">
          <div class="events-toolbar">
            <input type="text" class="search-input" placeholder="üîç  Search events..." oninput="filterEvents()" id="searchInput">
            <select class="filter-select" onchange="filterEvents()" id="filterType">
              <option value="">All Types</option>
              <option value="meeting">Meeting</option>
              <option value="deadline">Deadline</option>
              <option value="personal">Personal</option>
              <option value="reminder">Reminder</option>
              <option value="focus">Focus Time</option>
            </select>
          </div>
          <div id="eventsList"></div>
        </div>

        <!-- AI PLANNER -->
        <div class="view" id="view-planner">
          <div class="card" style="margin-bottom:20px">
            <div class="card-title">AI Schedule Advisor</div>
            <p style="color:var(--text-muted);font-size:14px;margin-bottom:16px">Ask for scheduling advice based on your calendar</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
              <button class="btn btn-ghost btn-sm" onclick="askPlanner('morning routine')">üåÖ Morning Routine</button>
              <button class="btn btn-ghost btn-sm" onclick="askPlanner('deep work focus')">üß† Deep Work</button>
              <button class="btn btn-ghost btn-sm" onclick="askPlanner('meeting optimization')">üìä Meetings</button>
              <button class="btn btn-ghost btn-sm" onclick="askPlanner('work life balance')">‚öñÔ∏è Balance</button>
            </div>
            <div style="display:flex;gap:10px">
              <input type="text" class="field-input" id="plannerInput" placeholder="Ask anything about your schedule..." style="flex:1">
              <button class="btn btn-primary" onclick="askPlanner()">Ask</button>
            </div>
          </div>
          <div class="card" id="plannerOutput" style="display:none"></div>
          <div class="stats-grid" id="analyticsCards"></div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div class="view" id="view-admin">
          <div class="stats-grid" id="adminStats"></div>
          <div class="card" style="margin-bottom:20px">
            <div class="card-title">
              All Users
              <input type="text" class="search-input" placeholder="Search users..." oninput="filterUsers()" id="userSearch" style="width:220px;font-size:13px;padding:8px 12px">
            </div>
            <div style="overflow-x:auto">
              <table class="user-table" id="usersTable">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Joined</th>
                    <th>Events</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="two-col">
            <div class="card">
              <div class="card-title">Recent Signups</div>
              <div id="recentSignups"></div>
            </div>
            <div class="card">
              <div class="card-title">Platform Activity</div>
              <div id="platformActivity"></div>
            </div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="view" id="view-settings">
          <div class="two-col">
            <div class="card">
              <div class="card-title">Profile</div>
              <div class="field-group">
                <label class="field-label">Display Name</label>
                <input type="text" class="field-input" id="settingsName" placeholder="Your name">
              </div>
              <div class="field-group">
                <label class="field-label">Title / Role</label>
                <input type="text" class="field-input" id="settingsTitle" placeholder="e.g. Product Manager">
              </div>
              <div class="field-group">
                <label class="field-label">Meeting Duration (minutes)</label>
                <select class="field-input" id="settingsDuration">
                  <option value="15">15 min</option>
                  <option value="30" selected>30 min</option>
                  <option value="45">45 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
            </div>
            <div class="card">
              <div class="card-title">Availability</div>
              <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">Set which days/hours you're available for bookings</p>
              <div id="availabilitySettings"></div>
              <button class="btn btn-primary" style="margin-top:16px;width:100%" onclick="saveAvailability()">Save Availability</button>
            </div>
          </div>
          <div class="card" style="margin-top:20px">
            <div class="card-title">Your Booking Link</div>
            <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">Share this link so others can book time with you</p>
            <div class="share-link-box" id="myBookingLink" style="margin-bottom:12px"></div>
            <div style="display:flex;gap:10px">
              <button class="btn btn-ghost btn-sm" onclick="copyBookingLink()">üìã Copy Link</button>
              <button class="btn btn-ghost btn-sm" onclick="previewBookingPage()">üëÅ Preview</button>
            </div>
          </div>
          <div class="card" style="margin-top:20px" id="googleCalCard">
            <div class="card-title">Google Calendar</div>
            <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">Connect your Google Calendar to sync events</p>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <div class="field-group" style="flex:1;min-width:200px">
                <label class="field-label">Client ID</label>
                <input type="text" class="field-input" id="clientIdInput" placeholder="...apps.googleusercontent.com">
              </div>
              <div class="field-group" style="flex:1;min-width:200px">
                <label class="field-label">API Key</label>
                <input type="text" class="field-input" id="apiKeyInput" placeholder="AIza...">
              </div>
            </div>
            <button class="btn btn-primary btn-sm" onclick="saveGoogleConfig()">Save & Connect</button>
            <div id="setupStatus" style="margin-top:12px"></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->
<!-- Event Modal -->
<div class="modal-overlay" id="eventModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="eventModalTitle">New Event</div>
      <button class="modal-close" onclick="closeModal('eventModal')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editEventId">
      <div class="field-group">
        <label class="field-label">Title *</label>
        <input type="text" class="field-input" id="eventTitle" placeholder="Event title">
      </div>
      <div class="field-row">
        <div class="field-group">
          <label class="field-label">Date</label>
          <input type="date" class="field-input" id="eventDate">
        </div>
        <div class="field-group">
          <label class="field-label">Type</label>
          <select class="field-input" id="eventType">
            <option value="meeting">Meeting</option>
            <option value="deadline">Deadline</option>
            <option value="personal">Personal</option>
            <option value="reminder">Reminder</option>
            <option value="focus">Focus Time</option>
          </select>
        </div>
      </div>
      <div class="field-row">
        <div class="field-group">
          <label class="field-label">Start Time</label>
          <input type="time" class="field-input" id="eventStart">
        </div>
        <div class="field-group">
          <label class="field-label">End Time</label>
          <input type="time" class="field-input" id="eventEnd">
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">Location</label>
        <input type="text" class="field-input" id="eventLocation" placeholder="Location or video link">
      </div>
      <div class="field-group">
        <label class="field-label">Attendees (emails, comma separated)</label>
        <input type="text" class="field-input" id="eventAttendees" placeholder="person@example.com, ...">
      </div>
      <div class="field-group">
        <label class="field-label">Notes</label>
        <textarea class="field-input" id="eventDesc" placeholder="Additional details..."></textarea>
      </div>
      <div class="field-group">
        <label class="field-label">Color</label>
        <div class="color-row" id="colorPicker"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('eventModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEvent()">Save Event</button>
    </div>
  </div>
</div>

<!-- Share / Booking Link Modal -->
<div class="modal-overlay" id="shareModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üîó Your Booking Link</div>
      <button class="modal-close" onclick="closeModal('shareModal')">√ó</button>
    </div>
    <div class="modal-body">
      <p style="color:var(--text-muted);font-size:14px;margin-bottom:20px">Share this link so others can book time in your calendar. They'll see your available slots and pick one ‚Äî just like Calendly.</p>
      <div class="field-group">
        <label class="field-label">Your Booking Link</label>
        <div class="share-link-box" id="shareLinkDisplay"></div>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:24px">
        <button class="btn btn-primary btn-sm" onclick="copyBookingLink()">üìã Copy Link</button>
        <button class="btn btn-ghost btn-sm" onclick="previewBookingPage()">üëÅ Preview Page</button>
      </div>
      <div style="background:var(--surface2);border-radius:var(--radius);padding:16px">
        <div style="font-size:13px;font-weight:600;margin-bottom:12px">How it works:</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.8">
          1. Someone opens your booking link<br>
          2. They see your available time slots<br>
          3. They pick a time and fill in their details<br>
          4. The meeting appears in your ChronoSync calendar instantly<br>
          5. If Google Calendar is connected, it syncs there too
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Event Detail Panel -->
<div class="detail-panel" id="detailPanel">
  <button class="detail-close" onclick="closeDetail()">√ó</button>
  <div id="detailContent"></div>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- ‚ïê‚ïê‚ïê FIREBASE + APP SCRIPTS ‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut as fbSignOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// ‚îÄ‚îÄ Firebase Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyArc8B3dofFqM9VS62o_VpKMcAX56HqAbs",
  authDomain: "chronosync-3bceb.firebaseapp.com",
  projectId: "chronosync-3bceb",
  storageBucket: "chronosync-3bceb.firebasestorage.app",
  messagingSenderId: "95043318836",
  appId: "1:95043318836:web:832707db193ca95b420661"
};

const fbApp  = initializeApp(firebaseConfig);
const auth   = getAuth(fbApp);
const db     = getFirestore(fbApp);
const gProvider = new GoogleAuthProvider();

// ‚îÄ‚îÄ Admin UID (your account) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ADMIN_UID = 'REPLACE_WITH_YOUR_UID'; // Will be set on first login

// ‚îÄ‚îÄ App State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser = null;
let userProfile = null;
let events = [];
let calDate = new Date();
let calView = 'month';
let selectedBookingDate = null;
let selectedBookingSlot = null;
let allUsers = [];
let eventsUnsubscribe = null;
let bookingsUnsubscribe = null;
let adminUid = localStorage.getItem('cs_admin_uid') || '';

// ‚îÄ‚îÄ Google Calendar State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tokenClient = null;
let gapiReady = false;
let gisReady  = false;
const GCAL_SCOPES = 'https://www.googleapis.com/auth/calendar';
const GCAL_DISCOVERY = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.switchAuthTab = (tab) => {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'&&i===0)||(tab==='register'&&i===1)));
  document.getElementById('loginForm').style.display    = tab==='login'    ? '' : 'none';
  document.getElementById('registerForm').style.display = tab==='register' ? '' : 'none';
  document.getElementById('authError').style.display = 'none';
};

window.signIn = async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPassword').value;
  if (!email || !pass) return showAuthError('Please fill in all fields');
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) { showAuthError(friendlyAuthError(e.code)); }
};

window.register = async () => {
  const name  = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pass  = document.getElementById('regPassword').value;
  if (!name || !email || !pass) return showAuthError('Please fill in all fields');
  if (pass.length < 6) return showAuthError('Password must be at least 6 characters');
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name });
    await createUserProfile(cred.user, name);
  } catch(e) { showAuthError(friendlyAuthError(e.code)); }
};

window.signInGoogle = async () => {
  try {
    const cred = await signInWithPopup(auth, gProvider);
    const isNew = cred._tokenResponse?.isNewUser;
    if (isNew) await createUserProfile(cred.user, cred.user.displayName || 'User');
  } catch(e) { showAuthError(friendlyAuthError(e.code)); }
};

window.signOut = async () => {
  if (eventsUnsubscribe)   eventsUnsubscribe();
  if (bookingsUnsubscribe) bookingsUnsubscribe();
  await fbSignOut(auth);
};

async function createUserProfile(user, name) {
  await setDoc(doc(db, 'users', user.uid), {
    name,
    email: user.email,
    title: '',
    createdAt: serverTimestamp(),
    status: 'active',
    meetingDuration: 30,
    availability: defaultAvailability(),
    googleCalConfig: {},
    googleConnected: false,
    eventCount: 0,
  }, { merge: true });
}

function defaultAvailability() {
  return {
    monday:    { enabled: true,  start: '09:00', end: '17:00' },
    tuesday:   { enabled: true,  start: '09:00', end: '17:00' },
    wednesday: { enabled: true,  start: '09:00', end: '17:00' },
    thursday:  { enabled: true,  start: '09:00', end: '17:00' },
    friday:    { enabled: true,  start: '09:00', end: '17:00' },
    saturday:  { enabled: false, start: '10:00', end: '14:00' },
    sunday:    { enabled: false, start: '10:00', end: '14:00' },
  };
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg;
  el.style.display = 'block';
}

function friendlyAuthError(code) {
  const m = {
    'auth/user-not-found':    'No account found with this email.',
    'auth/wrong-password':    'Incorrect password.',
    'auth/email-already-in-use': 'This email is already registered.',
    'auth/invalid-email':     'Invalid email address.',
    'auth/weak-password':     'Password must be at least 6 characters.',
    'auth/popup-closed-by-user': 'Sign-in popup was closed.',
    'auth/invalid-credential': 'Invalid email or password.',
  };
  return m[code] || 'Authentication failed. Please try again.';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTH STATE LISTENER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  // Check if booking page
  const urlParams = new URLSearchParams(location.search);
  const bookUid = urlParams.get('book');
  if (bookUid) {
    document.getElementById('authScreen').style.display  = 'none';
    document.getElementById('bookingScreen').style.display = 'block';
    loadBookingPage(bookUid);
    return;
  }

  if (user) {
    currentUser = user;
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';

    // Load profile
    const snap = await getDoc(doc(db, 'users', user.uid));
    if (snap.exists()) {
      userProfile = snap.data();
    } else {
      await createUserProfile(user, user.displayName || 'User');
      userProfile = (await getDoc(doc(db, 'users', user.uid))).data();
    }

    // Check/set admin
    if (!adminUid) {
      // First user to log in becomes admin
      const allSnap = await getDocs(collection(db, 'users'));
      if (allSnap.size === 1) {
        localStorage.setItem('cs_admin_uid', user.uid);
        adminUid = user.uid;
        await updateDoc(doc(db, 'users', user.uid), { isAdmin: true });
        userProfile.isAdmin = true;
      }
    }
    if (userProfile.isAdmin || user.uid === adminUid) {
      userProfile.isAdmin = true;
      document.getElementById('adminNavSection').style.display = '';
      document.getElementById('nav-admin').style.display = '';
    }

    // Init UI
    initApp();
    subscribeToEvents();

    // Load Google Calendar libs if configured
    if (userProfile.googleCalConfig?.clientId) {
      loadGoogleLibraries();
    }
  } else {
    currentUser = null;
    userProfile = null;
    document.getElementById('authScreen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT APP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initApp() {
  const name = userProfile?.name || currentUser?.displayName || 'User';
  const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2);

  document.getElementById('sidebarName').textContent = name;
  document.getElementById('sidebarRole').textContent = userProfile?.isAdmin ? 'üëë Admin' : userProfile?.title || 'Member';
  document.getElementById('sidebarAvatar').textContent = initials;
  document.getElementById('topbarDate').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  // Settings prefill
  document.getElementById('settingsName').value  = userProfile?.name  || '';
  document.getElementById('settingsTitle').value = userProfile?.title || '';
  document.getElementById('settingsDuration').value = userProfile?.meetingDuration || 30;
  if (userProfile?.googleCalConfig?.clientId) {
    document.getElementById('clientIdInput').value = userProfile.googleCalConfig.clientId;
    document.getElementById('apiKeyInput').value   = userProfile.googleCalConfig.apiKey || '';
  }

  // Booking link
  const bookLink = `${location.origin}${location.pathname}?book=${currentUser.uid}`;
  const lel = document.getElementById('myBookingLink');
  if (lel) lel.textContent = bookLink;
  const sel = document.getElementById('shareLinkDisplay');
  if (sel) sel.textContent = bookLink;

  initColorPicker();
  renderMiniCal();
  renderAvailabilitySettings();
  showView('dashboard');
  document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
  updateGCalBtn();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIRESTORE EVENTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribeToEvents() {
  if (eventsUnsubscribe) eventsUnsubscribe();
  const q = query(
    collection(db, 'events'),
    where('uid', '==', currentUser.uid),
    orderBy('date', 'asc')
  );
  eventsUnsubscribe = onSnapshot(q, (snap) => {
    events = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderAll();
  }, (err) => {
    console.error('Events subscription error:', err);
    // Fallback: try without orderBy (index might not exist)
    const q2 = query(collection(db, 'events'), where('uid', '==', currentUser.uid));
    eventsUnsubscribe = onSnapshot(q2, (snap) => {
      events = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.date||'').localeCompare(b.date||''));
      renderAll();
    });
  });
}

async function saveEvent() {
  const title = document.getElementById('eventTitle').value.trim();
  if (!title) return showToast('Please enter a title', 'error');

  const id = document.getElementById('editEventId').value;
  const eventData = {
    uid: currentUser.uid,
    title,
    date:      document.getElementById('eventDate').value || new Date().toISOString().split('T')[0],
    start:     document.getElementById('eventStart').value,
    end:       document.getElementById('eventEnd').value,
    type:      document.getElementById('eventType').value,
    desc:      document.getElementById('eventDesc').value,
    location:  document.getElementById('eventLocation').value,
    attendees: document.getElementById('eventAttendees').value,
    color:     document.querySelector('.color-dot.selected')?.dataset.color || '#6366f1',
    manuallyCreated: true,
    updatedAt: serverTimestamp(),
  };

  try {
    if (id) {
      await updateDoc(doc(db, 'events', id), eventData);
      showToast('Event updated!', 'success');
    } else {
      eventData.createdAt = serverTimestamp();
      const ref = await addDoc(collection(db, 'events'), eventData);
      // Sync to Google Calendar if connected
      if (userProfile?.googleConnected) addToGoogleCalendar({ ...eventData, id: ref.id });
    }
    closeModal('eventModal');
  } catch(e) {
    console.error(e);
    showToast('Failed to save event', 'error');
  }
}
window.saveEvent = saveEvent;

async function deleteEvent(id) {
  if (!confirm('Delete this event?')) return;
  try {
    await deleteDoc(doc(db, 'events', id));
    closeDetail();
    showToast('Event deleted', 'success');
  } catch(e) { showToast('Failed to delete', 'error'); }
}
window.deleteEvent = deleteEvent;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VIEWS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showView = (view) => {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const el = document.getElementById(`view-${view}`);
  if (el) el.classList.add('active');
  const nav = document.getElementById(`nav-${view}`);
  if (nav) nav.classList.add('active');
  const titles = { dashboard:'Dashboard', calendar:'Calendar', events:'All Events', planner:'AI Planner', admin:'Admin Dashboard', settings:'Settings' };
  document.getElementById('pageTitle').textContent = titles[view] || view;
  if (view === 'calendar') renderCalendar();
  if (view === 'events')   renderEventsList();
  if (view === 'dashboard') renderDashboard();
  if (view === 'planner')  renderAnalytics();
  if (view === 'admin')    renderAdminDashboard();
  closeSidebar();
};

function renderAll() {
  renderDashboard();
  if (document.getElementById('view-calendar')?.classList.contains('active')) renderCalendar();
  if (document.getElementById('view-events')?.classList.contains('active')) renderEventsList();
  renderMiniCal();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DASHBOARD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  const today = new Date().toISOString().split('T')[0];
  const todayEvents = events.filter(e => e.date === today);
  const upcoming = events.filter(e => e.date > today).slice(0,6);
  const total = events.length;
  const meetings = events.filter(e=>e.type==='meeting').length;

  document.getElementById('dashStats').innerHTML = `
    <div class="stat-card" style="--accent-color:#6366f1">
      <div class="stat-num">${total}</div>
      <div class="stat-label">Total Events</div>
    </div>
    <div class="stat-card" style="--accent-color:#f472b6">
      <div class="stat-num">${todayEvents.length}</div>
      <div class="stat-label">Today</div>
    </div>
    <div class="stat-card" style="--accent-color:#34d399">
      <div class="stat-num">${upcoming.length}</div>
      <div class="stat-label">Upcoming</div>
    </div>
    <div class="stat-card" style="--accent-color:#fbbf24">
      <div class="stat-num">${meetings}</div>
      <div class="stat-label">Meetings</div>
    </div>`;

  document.getElementById('todayLabel').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});

  const todayEl = document.getElementById('todayEvents');
  if (todayEvents.length === 0) {
    todayEl.innerHTML = `<div class="empty" style="padding:30px 20px"><div class="empty-icon">‚òÄÔ∏è</div><p>No events scheduled today</p></div>`;
  } else {
    todayEl.innerHTML = todayEvents.sort((a,b)=>(a.start||'').localeCompare(b.start||'')).map(e => `
      <div class="event-item" onclick="showDetail('${e.id}')">
        <div class="event-dot" style="background:${e.color||'#6366f1'}"></div>
        <div class="event-info">
          <div class="event-title">${e.title}</div>
          <div class="event-meta">${e.start ? e.start+(e.end?' ‚Äì '+e.end:'') : 'All day'}${e.location?' ¬∑ '+e.location:''}</div>
        </div>
        <span class="event-tag tag-${e.type||'meeting'}">${cap(e.type||'meeting')}</span>
      </div>`).join('');
  }

  const upEl = document.getElementById('upcomingEvents');
  if (upcoming.length === 0) {
    upEl.innerHTML = `<div class="empty" style="padding:30px 20px"><div class="empty-icon">üóìÔ∏è</div><p>No upcoming events</p></div>`;
  } else {
    upEl.innerHTML = upcoming.map(e => {
      const d = new Date(e.date+'T12:00:00');
      return `<div class="event-item" onclick="showDetail('${e.id}')">
        <div class="event-dot" style="background:${e.color||'#6366f1'}"></div>
        <div class="event-info">
          <div class="event-title">${e.title}</div>
          <div class="event-meta">${d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}${e.start?' ¬∑ '+e.start:''}</div>
        </div>
      </div>`;
    }).join('');
  }

  // Recent bookings
  loadRecentBookings();
}

async function loadRecentBookings() {
  const el = document.getElementById('recentBookings');
  if (!el || !currentUser) return;
  try {
    const q = query(collection(db,'bookings'), where('hostUid','==',currentUser.uid), orderBy('createdAt','desc'), limit(5));
    const snap = await getDocs(q);
    if (snap.empty) {
      el.innerHTML = `<div class="empty" style="padding:20px"><p>No bookings yet ‚Äî share your booking link to get started!</p></div>`;
      return;
    }
    el.innerHTML = snap.docs.map(d => {
      const b = d.data();
      return `<div class="event-item">
        <div class="event-dot" style="background:#6366f1"></div>
        <div class="event-info">
          <div class="event-title">${b.bookerName} booked a ${b.duration||30}-min meeting</div>
          <div class="event-meta">${b.date} at ${b.time} ¬∑ ${b.bookerEmail}</div>
          ${b.reason ? `<div class="event-meta" style="color:var(--text-dim)">${b.reason}</div>` : ''}
        </div>
        <span class="event-tag tag-meeting">Booked</span>
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = `<div class="empty" style="padding:20px"><p>No bookings yet</p></div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CALENDAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.calNav = (dir) => {
  if (calView === 'month') calDate.setMonth(calDate.getMonth()+dir);
  else calDate.setDate(calDate.getDate()+dir*7);
  renderCalendar();
};
window.setCalView = (v, el) => {
  calView = v;
  document.querySelectorAll('.cal-view-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderCalendar();
};

function renderCalendar() {
  document.getElementById('calTitle').textContent = calDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  if (calView==='month') renderMonthCal();
  else renderWeekCal();
}

function renderMonthCal() {
  const year = calDate.getFullYear(), month = calDate.getMonth();
  const today = new Date().toISOString().split('T')[0];
  const firstDay = new Date(year,month,1).getDay();
  const daysInMonth = new Date(year,month+1,0).getDate();
  const prevDays = new Date(year,month,0).getDate();

  let html = '<div class="cal-grid">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => html += `<div class="cal-day-header">${d}</div>`);

  for (let i=firstDay-1;i>=0;i--) {
    const ds = `${year}-${String(month).padStart(2,'0')}-${String(prevDays-i).padStart(2,'0')}`;
    html += `<div class="cal-day other-month" onclick="openNewEventOnDate('${ds}')"><div class="day-num">${prevDays-i}</div></div>`;
  }
  for (let d=1;d<=daysInMonth;d++) {
    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = ds===today;
    const dayEvts = events.filter(e=>e.date===ds);
    const chips = dayEvts.slice(0,3).map(e=>`<div class="cal-event-chip" style="background:${e.color||'#6366f1'}22;color:${e.color||'#6366f1'}" onclick="event.stopPropagation();showDetail('${e.id}')">${e.title}</div>`).join('');
    const more = dayEvts.length>3 ? `<div class="more-events">+${dayEvts.length-3} more</div>` : '';
    html += `<div class="cal-day${isToday?' today':''}" onclick="openNewEventOnDate('${ds}')"><div class="day-num">${d}</div>${chips}${more}</div>`;
  }
  const remaining = 42-(firstDay+daysInMonth);
  for (let d=1;d<=remaining;d++) {
    const ds = `${year}-${String(month+2).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    html += `<div class="cal-day other-month" onclick="openNewEventOnDate('${ds}')"><div class="day-num">${d}</div></div>`;
  }
  html += '</div>';
  document.getElementById('calContainer').innerHTML = html;
}

function renderWeekCal() {
  const weekStart = new Date(calDate);
  weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const today = new Date().toISOString().split('T')[0];
  const HOURS = Array.from({length:14},(_,i)=>i+7);
  const DAYS = Array.from({length:7},(_,i)=>{const d=new Date(weekStart);d.setDate(weekStart.getDate()+i);return d;});

  const headers = DAYS.map(d=>{
    const ds=d.toISOString().split('T')[0];
    const isT=ds===today;
    return `<div style="text-align:center;padding:10px 4px;font-size:12px;${isT?'color:var(--accent);font-weight:700':'color:var(--text-muted)'}">
      ${d.toLocaleDateString('en-US',{weekday:'short'})}<br>
      <span style="font-size:18px;font-weight:700">${d.getDate()}</span>
    </div>`;
  }).join('');

  const rows = HOURS.map(h=>{
    const timeLabel = h===0?'12am':h<12?h+'am':h===12?'12pm':(h-12)+'pm';
    const cells = DAYS.map(d=>{
      const ds=d.toISOString().split('T')[0];
      const slotEvts=events.filter(e=>e.date===ds&&e.start&&parseInt(e.start.split(':')[0])===h);
      const evChips=slotEvts.map(e=>`<div onclick="showDetail('${e.id}')" style="background:${e.color||'#6366f1'}33;border-left:3px solid ${e.color||'#6366f1'};padding:4px 6px;font-size:11px;border-radius:4px;margin-bottom:2px;cursor:pointer;color:${e.color||'#6366f1'}">${e.title}</div>`).join('');
      return `<div style="border-left:1px solid var(--border);padding:4px;min-height:48px;cursor:pointer" onclick="openNewEventOnDate('${ds}','${String(h).padStart(2,'0')}:00')">${evChips}</div>`;
    }).join('');
    return `<div style="display:grid;grid-template-columns:56px repeat(7,1fr);border-top:1px solid var(--border)">
      <div style="padding:4px 8px;font-size:11px;color:var(--text-dim);padding-top:6px">${timeLabel}</div>${cells}</div>`;
  }).join('');

  document.getElementById('calContainer').innerHTML = `
    <div style="overflow-x:auto">
      <div style="min-width:600px">
        <div style="display:grid;grid-template-columns:56px repeat(7,1fr)">${'<div></div>'}${headers}</div>
        ${rows}
      </div>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EVENTS LIST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEventsList() {
  filterEvents();
}
window.filterEvents = () => {
  const search = (document.getElementById('searchInput')?.value||'').toLowerCase();
  const type   = document.getElementById('filterType')?.value||'';
  const filtered = events.filter(e=>{
    const ms = !search || e.title?.toLowerCase().includes(search) || (e.desc||'').toLowerCase().includes(search);
    const mt = !type || e.type===type;
    return ms&&mt;
  }).sort((a,b)=>(a.date||'').localeCompare(b.date||''));
  const el = document.getElementById('eventsList');
  if (!el) return;
  if (filtered.length===0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><h3>No events found</h3><p>Try a different search or create a new event.</p></div>`;
    return;
  }
  el.innerHTML = filtered.map(e=>{
    const d=new Date((e.date||new Date().toISOString().split('T')[0])+'T12:00:00');
    return `<div class="event-row" onclick="showDetail('${e.id}')">
      <div class="event-row-date"><div class="day" style="color:${e.color||'#6366f1'}">${d.getDate()}</div><div class="mon">${d.toLocaleDateString('en-US',{month:'short'})}</div></div>
      <div class="event-row-divider"></div>
      <div class="event-row-info">
        <div class="event-row-title">${e.title}</div>
        <div class="event-row-meta">
          ${e.start?`<span>üïê ${e.start}${e.end?' ‚Äì '+e.end:''}</span>`:'<span>All day</span>'}
          ${e.location?`<span>üìç ${e.location}</span>`:''}
          <span class="event-tag tag-${e.type||'meeting'}">${cap(e.type||'meeting')}</span>
        </div>
      </div>
      <div class="event-row-actions" onclick="event.stopPropagation()">
        <button class="btn btn-ghost btn-xs" onclick="editEvent('${e.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-xs" onclick="deleteEvent('${e.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EVENT DETAIL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showDetail = (id) => {
  const e = events.find(ev=>ev.id===id);
  if (!e) return;
  const d = new Date((e.date||'')+'T12:00:00');
  document.getElementById('detailContent').innerHTML = `
    <div style="height:4px;border-radius:2px;background:${e.color||'#6366f1'};margin-bottom:20px;margin-top:8px"></div>
    <h2 style="font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:8px">${e.title}</h2>
    <span class="event-tag tag-${e.type||'meeting'}">${cap(e.type||'meeting')}</span>
    <div style="margin-top:20px;display:flex;flex-direction:column;gap:12px">
      <div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Date</div><div style="font-size:14px">${d.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div></div>
      ${e.start?`<div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Time</div><div style="font-size:14px">${e.start}${e.end?' ‚Äì '+e.end:''}</div></div>`:''}
      ${e.location?`<div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Location</div><div style="font-size:14px">${e.location}</div></div>`:''}
      ${e.attendees?`<div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Attendees</div><div style="font-size:13px;color:var(--text-muted)">${e.attendees}</div></div>`:''}
      ${e.desc?`<div><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Notes</div><div style="font-size:14px;line-height:1.6;color:var(--text-muted)">${e.desc}</div></div>`:''}
    </div>
    <div style="display:flex;gap:8px;margin-top:24px">
      <button class="btn btn-ghost btn-sm" style="flex:1" onclick="editEvent('${e.id}')">‚úèÔ∏è Edit</button>
      <button class="btn btn-danger btn-sm" style="flex:1" onclick="deleteEvent('${e.id}')">üóëÔ∏è Delete</button>
    </div>`;
  document.getElementById('detailPanel').classList.add('open');
};
window.closeDetail = () => document.getElementById('detailPanel').classList.remove('open');

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EVENT MODAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openNewEvent = () => {
  document.getElementById('editEventId').value = '';
  document.getElementById('eventModalTitle').textContent = 'New Event';
  document.getElementById('eventTitle').value = '';
  document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('eventStart').value = '';
  document.getElementById('eventEnd').value = '';
  document.getElementById('eventType').value = 'meeting';
  document.getElementById('eventLocation').value = '';
  document.getElementById('eventAttendees').value = '';
  document.getElementById('eventDesc').value = '';
  document.querySelectorAll('.color-dot').forEach((d,i)=>d.classList.toggle('selected',i===0));
  openModal('eventModal');
};

window.openNewEventOnDate = (date, time='') => {
  openNewEvent();
  document.getElementById('eventDate').value = date;
  if (time) document.getElementById('eventStart').value = time;
};

window.editEvent = (id) => {
  const e = events.find(ev=>ev.id===id);
  if (!e) return;
  document.getElementById('editEventId').value = e.id;
  document.getElementById('eventModalTitle').textContent = 'Edit Event';
  document.getElementById('eventTitle').value = e.title||'';
  document.getElementById('eventDate').value  = e.date||'';
  document.getElementById('eventStart').value = e.start||'';
  document.getElementById('eventEnd').value   = e.end||'';
  document.getElementById('eventType').value  = e.type||'meeting';
  document.getElementById('eventLocation').value  = e.location||'';
  document.getElementById('eventAttendees').value = e.attendees||'';
  document.getElementById('eventDesc').value  = e.desc||'';
  document.querySelectorAll('.color-dot').forEach(d=>d.classList.toggle('selected',d.dataset.color===e.color));
  closeDetail();
  openModal('eventModal');
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MINI CALENDAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let miniDate = new Date();
function renderMiniCal() {
  const el = document.getElementById('miniCalContainer');
  if (!el) return;
  const y=miniDate.getFullYear(), m=miniDate.getMonth();
  const today=new Date().toISOString().split('T')[0];
  const firstDay=new Date(y,m,1).getDay();
  const days=new Date(y,m+1,0).getDate();
  const prevDays=new Date(y,m,0).getDate();
  let cells='';
  for(let i=firstDay-1;i>=0;i--){
    cells+=`<div class="mini-cal-d other">${prevDays-i}</div>`;
  }
  for(let d=1;d<=days;d++){
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isT=ds===today;
    const hasEv=events.some(e=>e.date===ds);
    cells+=`<div class="mini-cal-d${isT?' today':hasEv?' has-events':''}" onclick="miniCalClick('${ds}')">${d}</div>`;
  }
  el.innerHTML=`<div class="mini-cal">
    <div class="mini-cal-header">
      <button class="mini-cal-nav" onclick="miniCalNav(-1)">‚Äπ</button>
      <span>${miniDate.toLocaleDateString('en-US',{month:'short',year:'numeric'})}</span>
      <button class="mini-cal-nav" onclick="miniCalNav(1)">‚Ä∫</button>
    </div>
    <div class="mini-cal-grid">
      ${['S','M','T','W','T','F','S'].map(d=>`<div class="mini-cal-dh">${d}</div>`).join('')}
      ${cells}
    </div>
  </div>`;
}
window.miniCalNav = (dir) => { miniDate.setMonth(miniDate.getMonth()+dir); renderMiniCal(); };
window.miniCalClick = (ds) => { calDate=new Date(ds+'T12:00:00'); showView('calendar'); };

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AI PLANNER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.askPlanner = (preset='') => {
  const q = preset || document.getElementById('plannerInput').value.toLowerCase();
  if (!q) return showToast('Enter a question first', 'error');
  const total=events.length, todayStr=new Date().toISOString().split('T')[0];
  const todayEvts=events.filter(e=>e.date===todayStr);
  const meetings=events.filter(e=>e.type==='meeting').length;
  const busyHours=events.filter(e=>e.start).map(e=>parseInt(e.start)).sort((a,b)=>a-b);
  const mostBusy=busyHours.length?busyHours[Math.floor(busyHours.length/2)]:9;
  let advice='';
  if(q.includes('morning')||q.includes('routine')){
    advice=`<h3 style="font-family:'Syne',sans-serif;margin-bottom:12px">üåÖ Optimal Morning Routine</h3>
    <p style="color:var(--text-muted);margin-bottom:16px">Based on your ${total} events, here's an ideal morning framework:</p>
    <div style="display:flex;flex-direction:column;gap:10px">
      ${['6:00‚Äì6:30 ‚Äî Wake, hydrate, 5-min journal','6:30‚Äì7:00 ‚Äî Movement/exercise (non-negotiable)','7:00‚Äì7:30 ‚Äî Review your ChronoSync dashboard','7:30‚Äì8:00 ‚Äî Deep focus prep: no email, no Slack','8:00‚Äì9:00 ‚Äî Tackle your #1 priority task'].map(s=>`<div style="padding:12px 14px;background:var(--surface2);border-radius:8px;font-size:14px">${s}</div>`).join('')}
    </div>`;
  } else if(q.includes('deep')||q.includes('focus')){
    advice=`<h3 style="font-family:'Syne',sans-serif;margin-bottom:12px">üß† Deep Work Strategy</h3>
    <p style="color:var(--text-muted);margin-bottom:16px">Your peak hours based on your calendar data:</p>
    <div style="display:flex;flex-direction:column;gap:10px">
      ${['Block 9:00‚Äì12:00 as sacred deep work time','Use Pomodoro: 90-min focus + 20-min break','Disable notifications during focus blocks','Schedule your deep work in ChronoSync as "Focus Time" events','Review output at end of each block ‚Äî not mid-block'].map(s=>`<div style="padding:12px 14px;background:var(--surface2);border-radius:8px;font-size:14px">${s}</div>`).join('')}
    </div>`;
  } else if(q.includes('meeting')){
    advice=`<h3 style="font-family:'Syne',sans-serif;margin-bottom:12px">üìä Meeting Optimization</h3>
    <p style="color:var(--text-muted);margin-bottom:16px">You have ${meetings} meetings scheduled. Here's how to optimize:</p>
    <div style="display:flex;flex-direction:column;gap:10px">
      ${['Batch meetings: 10‚Äì11:30am and 2‚Äì4pm','Default to 25-min meetings (respect others\' time)','Add agenda to every meeting description','Declare Wednesdays meeting-free for deep work','End every meeting with a clear action item'].map(s=>`<div style="padding:12px 14px;background:var(--surface2);border-radius:8px;font-size:14px">${s}</div>`).join('')}
    </div>`;
  } else if(q.includes('balance')){
    advice=`<h3 style="font-family:'Syne',sans-serif;margin-bottom:12px">‚öñÔ∏è Work-Life Balance</h3>
    <p style="color:var(--text-muted);margin-bottom:16px">Here are personalized recommendations:</p>
    <div style="display:flex;flex-direction:column;gap:10px">
      ${['Set a hard stop at 6pm ‚Äî add it as a recurring event','Schedule personal events with the same urgency as work','Take at least one full day off per week','Add a "weekly review" event every Friday at 4pm','Use the Booking Link to control when people can reach you'].map(s=>`<div style="padding:12px 14px;background:var(--surface2);border-radius:8px;font-size:14px">${s}</div>`).join('')}
    </div>`;
  } else {
    advice=`<h3 style="font-family:'Syne',sans-serif;margin-bottom:12px">üìã Your Schedule Overview</h3>
    <p style="color:var(--text-muted);margin-bottom:16px">Here's an analysis of your current calendar:</p>
    <div style="display:flex;flex-direction:column;gap:10px">
      ${[`You have ${total} total events across your calendar`,`${todayEvts.length} events scheduled for today`,`Your busiest hour tends to be ${mostBusy}:00`,`${meetings} meetings (${total?Math.round(meetings/total*100):0}% of your calendar)`,`Tip: Try asking about "morning routine", "deep work", or "meeting optimization"`].map(s=>`<div style="padding:12px 14px;background:var(--surface2);border-radius:8px;font-size:14px">${s}</div>`).join('')}
    </div>`;
  }
  const out=document.getElementById('plannerOutput');
  out.innerHTML=advice;
  out.style.display='block';
};

function renderAnalytics() {
  const byType={};
  events.forEach(e=>{byType[e.type||'meeting']=(byType[e.type||'meeting']||0)+1;});
  const colors={meeting:'#6366f1',deadline:'#f87171',personal:'#34d399',reminder:'#fbbf24',focus:'#f472b6'};
  document.getElementById('analyticsCards').innerHTML=Object.entries(byType).map(([type,count])=>`
    <div class="stat-card" style="--accent-color:${colors[type]||'#6366f1'}">
      <div class="stat-num">${count}</div>
      <div class="stat-label">${cap(type)} events</div>
      <div style="height:3px;background:var(--surface3);border-radius:2px;margin-top:12px"><div style="height:3px;background:${colors[type]||'#6366f1'};border-radius:2px;width:${Math.min(100,(count/events.length)*100)}%"></div></div>
    </div>`).join('')||`<div class="empty"><p>No events to analyze yet</p></div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ADMIN DASHBOARD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderAdminDashboard() {
  if (!userProfile?.isAdmin) return;
  try {
    const usersSnap = await getDocs(collection(db,'users'));
    allUsers = usersSnap.docs.map(d=>({id:d.id,...d.data()}));
    const eventsSnap = await getDocs(collection(db,'events'));
    const bookingsSnap = await getDocs(collection(db,'bookings'));
    const totalEvents = eventsSnap.size;
    const totalBookings = bookingsSnap.size;
    const activeUsers = allUsers.filter(u=>u.status!=='banned').length;

    document.getElementById('adminStats').innerHTML = `
      <div class="stat-card" style="--accent-color:#6366f1">
        <div class="stat-num">${allUsers.length}</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card" style="--accent-color:#34d399">
        <div class="stat-num">${activeUsers}</div>
        <div class="stat-label">Active Users</div>
      </div>
      <div class="stat-card" style="--accent-color:#f472b6">
        <div class="stat-num">${totalEvents}</div>
        <div class="stat-label">Total Events</div>
      </div>
      <div class="stat-card" style="--accent-color:#fbbf24">
        <div class="stat-num">${totalBookings}</div>
        <div class="stat-label">Total Bookings</div>
      </div>`;

    renderUsersTable(allUsers);

    // Recent signups
    const recent = [...allUsers].sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).slice(0,5);
    document.getElementById('recentSignups').innerHTML = recent.map(u=>`
      <div class="event-item">
        <div class="user-avatar" style="width:32px;height:32px;font-size:12px;flex-shrink:0">${(u.name||'?').substring(0,2).toUpperCase()}</div>
        <div class="event-info">
          <div class="event-title">${u.name||'Unknown'}</div>
          <div class="event-meta">${u.email}</div>
        </div>
        ${u.isAdmin?`<span class="admin-badge">ADMIN</span>`:`<span class="event-tag tag-personal">Member</span>`}
      </div>`).join('');

    // Platform activity
    document.getElementById('platformActivity').innerHTML = `
      <div style="display:flex;flex-direction:column;gap:12px">
        <div style="display:flex;justify-content:space-between;font-size:14px"><span style="color:var(--text-muted)">Avg events per user</span><span style="font-weight:600">${allUsers.length?Math.round(totalEvents/allUsers.length):0}</span></div>
        <div style="display:flex;justify-content:space-between;font-size:14px"><span style="color:var(--text-muted)">Google Calendar connected</span><span style="font-weight:600">${allUsers.filter(u=>u.googleConnected).length}</span></div>
        <div style="display:flex;justify-content:space-between;font-size:14px"><span style="color:var(--text-muted)">Total bookings received</span><span style="font-weight:600">${totalBookings}</span></div>
        <div style="display:flex;justify-content:space-between;font-size:14px"><span style="color:var(--text-muted)">Banned users</span><span style="font-weight:600;color:var(--danger)">${allUsers.filter(u=>u.status==='banned').length}</span></div>
      </div>`;
  } catch(e) {
    console.error('Admin load error:', e);
    showToast('Failed to load admin data', 'error');
  }
}

function renderUsersTable(users) {
  const tbody = document.getElementById('usersTableBody');
  if (!tbody) return;
  tbody.innerHTML = users.map(u => `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px">${(u.name||'?').substring(0,2).toUpperCase()}</div>
          <div>
            <div style="font-weight:600">${u.name||'Unknown'}</div>
            ${u.isAdmin?`<span class="admin-badge">ADMIN</span>`:''}
          </div>
        </div>
      </td>
      <td style="color:var(--text-muted)">${u.email||'‚Äî'}</td>
      <td style="color:var(--text-muted)">${u.createdAt?.seconds ? new Date(u.createdAt.seconds*1000).toLocaleDateString() : '‚Äî'}</td>
      <td>${u.eventCount||0}</td>
      <td>
        <span class="status-dot ${u.status==='banned'?'status-banned':'status-active'}"></span>
        ${u.status==='banned'?'Banned':'Active'}
      </td>
      <td>
        <div style="display:flex;gap:6px">
          ${u.id!==currentUser.uid ? `
            <button class="btn btn-xs btn-ghost" onclick="viewUserEvents('${u.id}','${u.name||'User'}')">View</button>
            ${u.status==='banned'
              ? `<button class="btn btn-xs btn-ghost" onclick="toggleBanUser('${u.id}',false)">Unban</button>`
              : `<button class="btn btn-xs btn-danger" onclick="toggleBanUser('${u.id}',true)">Ban</button>`}
            <button class="btn btn-xs btn-danger" onclick="deleteUser('${u.id}','${u.email||''}')">Delete</button>
          ` : '<span style="color:var(--text-dim);font-size:12px">You</span>'}
        </div>
      </td>
    </tr>`).join('');
}

window.filterUsers = () => {
  const q = (document.getElementById('userSearch')?.value||'').toLowerCase();
  renderUsersTable(q ? allUsers.filter(u=>(u.name||'').toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q)) : allUsers);
};

window.toggleBanUser = async (uid, ban) => {
  if (!confirm(`${ban?'Ban':'Unban'} this user?`)) return;
  try {
    await updateDoc(doc(db,'users',uid), {status: ban?'banned':'active'});
    showToast(`User ${ban?'banned':'unbanned'}`, 'success');
    renderAdminDashboard();
  } catch(e) { showToast('Action failed', 'error'); }
};

window.deleteUser = async (uid, email) => {
  if (!confirm(`Permanently delete ${email}? This cannot be undone.`)) return;
  try {
    await deleteDoc(doc(db,'users',uid));
    // Delete their events too
    const evSnap = await getDocs(query(collection(db,'events'),where('uid','==',uid)));
    for (const d of evSnap.docs) await deleteDoc(d.ref);
    showToast('User deleted', 'success');
    renderAdminDashboard();
  } catch(e) { showToast('Delete failed', 'error'); }
};

window.viewUserEvents = async (uid, name) => {
  try {
    const snap = await getDocs(query(collection(db,'events'),where('uid','==',uid)));
    const userEvs = snap.docs.map(d=>d.data());
    alert(`${name}'s events (${userEvs.length} total):\n\n${userEvs.map(e=>`‚Ä¢ ${e.title} ‚Äî ${e.date}`).join('\n') || 'No events'}`);
  } catch(e) { showToast('Failed to load', 'error'); }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SETTINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.saveProfile = async () => {
  const name = document.getElementById('settingsName').value.trim();
  const title = document.getElementById('settingsTitle').value.trim();
  const dur   = document.getElementById('settingsDuration').value;
  if (!name) return showToast('Name is required', 'error');
  try {
    await updateDoc(doc(db,'users',currentUser.uid), {name, title, meetingDuration: parseInt(dur)});
    await updateProfile(currentUser, {displayName: name});
    userProfile = {...userProfile, name, title, meetingDuration: parseInt(dur)};
    document.getElementById('sidebarName').textContent = name;
    document.getElementById('sidebarAvatar').textContent = name.split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2);
    showToast('Profile saved!', 'success');
  } catch(e) { showToast('Failed to save', 'error'); }
};

function renderAvailabilitySettings() {
  const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
  const avail = userProfile?.availability || defaultAvailability();
  document.getElementById('availabilitySettings').innerHTML = days.map(day => {
    const a = avail[day] || {enabled:false,start:'09:00',end:'17:00'};
    return `<div class="day-toggle">
      <button class="toggle ${a.enabled?'on':''}" id="toggle-${day}" onclick="this.classList.toggle('on')"></button>
      <span style="width:90px;font-size:13px;text-transform:capitalize">${day}</span>
      <input type="time" value="${a.start}" id="avail-start-${day}" class="field-input" style="width:100px;padding:6px 10px;font-size:12px">
      <span style="color:var(--text-muted);font-size:13px">‚Äì</span>
      <input type="time" value="${a.end}" id="avail-end-${day}" class="field-input" style="width:100px;padding:6px 10px;font-size:12px">
    </div>`;
  }).join('');
}

window.saveAvailability = async () => {
  const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
  const availability = {};
  days.forEach(day => {
    availability[day] = {
      enabled: document.getElementById(`toggle-${day}`)?.classList.contains('on') || false,
      start:   document.getElementById(`avail-start-${day}`)?.value || '09:00',
      end:     document.getElementById(`avail-end-${day}`)?.value   || '17:00',
    };
  });
  try {
    await updateDoc(doc(db,'users',currentUser.uid), {availability});
    userProfile = {...userProfile, availability};
    showToast('Availability saved!', 'success');
  } catch(e) { showToast('Failed to save', 'error'); }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BOOKING LINK / SHARE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openShareModal = () => openModal('shareModal');

window.copyBookingLink = () => {
  const link = `${location.origin}${location.pathname}?book=${currentUser?.uid}`;
  navigator.clipboard.writeText(link).then(()=>showToast('Link copied!','success')).catch(()=>{
    const el = document.getElementById('shareLinkDisplay') || document.getElementById('myBookingLink');
    if(el){el.select&&el.select();document.execCommand('copy');showToast('Link copied!','success');}
  });
};

window.previewBookingPage = () => {
  const link = `${location.origin}${location.pathname}?book=${currentUser?.uid}`;
  window.open(link, '_blank');
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BOOKING PAGE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadBookingPage(hostUid) {
  try {
    const snap = await getDoc(doc(db,'users',hostUid));
    if (!snap.exists()) {
      document.getElementById('bookingScreen').innerHTML = `<div class="empty" style="margin-top:100px"><div class="empty-icon">üòï</div><h3>User not found</h3><p>This booking link is invalid.</p></div>`;
      return;
    }
    const host = snap.data();
    const initials = (host.name||'?').split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2);
    document.getElementById('bookingAvatar').textContent = initials;
    document.getElementById('bookingHostName').textContent = host.name || 'Unknown';
    document.getElementById('bookingHostTitle').textContent = host.title ? `${host.title} ‚Äî Book a meeting` : 'Book a meeting';

    // Render booking mini calendar
    renderBookingCal(hostUid, host);
  } catch(e) {
    console.error(e);
    document.getElementById('bookingScreen').innerHTML = `<div class="empty" style="margin-top:100px"><div class="empty-icon">‚ö†Ô∏è</div><h3>Failed to load</h3><p>Please try again later.</p></div>`;
  }
}

function renderBookingCal(hostUid, host) {
  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth();
  const firstDay = new Date(y,m,1).getDay();
  const daysInMonth = new Date(y,m+1,0).getDate();
  const todayStr = today.toISOString().split('T')[0];
  const avail = host.availability || defaultAvailability();
  const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

  let cells = '';
  for(let i=0;i<firstDay;i++) cells += `<div></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayOfWeek = new Date(ds+'T12:00:00').getDay();
    const dayName = dayNames[dayOfWeek];
    const isPast = ds < todayStr;
    const isAvail = avail[dayName]?.enabled && !isPast;
    cells += `<div onclick="${isAvail?`selectBookingDate('${ds}',event,${JSON.stringify(host.availability||{}).replace(/"/g,"'")},${host.meetingDuration||30})`:''}" style="text-align:center;padding:10px 4px;border-radius:8px;font-size:13px;cursor:${isAvail?'pointer':'default'};opacity:${isPast?0.3:1};background:${ds===selectedBookingDate?'var(--accent)':isAvail?'var(--surface2)':'transparent'};color:${ds===selectedBookingDate?'#fff':isAvail?'var(--text)':'var(--text-dim)'};transition:all .2s">${d}</div>`;
  }

  document.getElementById('bookingMiniCal').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px">
      ${['S','M','T','W','T','F','S'].map(d=>`<div style="text-align:center;font-size:11px;color:var(--text-dim);font-weight:700;padding:4px">${d}</div>`).join('')}
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px">${cells}</div>`;
}

window.selectBookingDate = async (date, evt, availStr, duration) => {
  selectedBookingDate = date;
  selectedBookingSlot = null;
  const d = new Date(date+'T12:00:00');
  document.getElementById('slotDateHeader').textContent = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  const urlParams = new URLSearchParams(location.search);
  const hostUid = urlParams.get('book');

  // Get booked slots for this date
  let bookedTimes = [];
  try {
    const q = query(collection(db,'bookings'), where('hostUid','==',hostUid), where('date','==',date));
    const snap = await getDocs(q);
    bookedTimes = snap.docs.map(d=>d.data().time);
  } catch(e) {}

  // Parse availability for this day
  const dayNames=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const dayName = dayNames[d.getDay()];
  const avail = userProfile?.availability || defaultAvailability();
  let hostAvail;
  try { hostAvail = typeof availStr === 'string' ? JSON.parse(availStr.replace(/'/g,'"')) : availStr; } catch(e) { hostAvail = defaultAvailability(); }
  const dayAvail = hostAvail?.[dayName] || {enabled:true, start:'09:00', end:'17:00'};

  const slots = generateTimeSlots(dayAvail.start, dayAvail.end, duration||30);
  document.getElementById('slotGrid').innerHTML = slots.length ? slots.map(slot => `
    <button class="slot-btn ${bookedTimes.includes(slot)?'booked':''}" onclick="selectSlot('${slot}')" ${bookedTimes.includes(slot)?'disabled':''}>
      ${slot}
    </button>`).join('') : `<div style="grid-column:1/-1;padding:20px;color:var(--text-muted);text-align:center">No slots available this day</div>`;

  document.getElementById('bookingFormSection').style.display = 'none';
  // Re-render cal to show selection
  const hostSnap = await getDoc(doc(db,'users',hostUid));
  if (hostSnap.exists()) renderBookingCal(hostUid, hostSnap.data());
};

function generateTimeSlots(start, end, duration) {
  const slots = [];
  let [h,m] = start.split(':').map(Number);
  const [eh,em] = end.split(':').map(Number);
  const endMins = eh*60+em;
  while(h*60+m+duration <= endMins) {
    slots.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
    m += duration;
    if(m>=60){h+=Math.floor(m/60);m=m%60;}
  }
  return slots;
}

window.selectSlot = (slot) => {
  selectedBookingSlot = slot;
  document.querySelectorAll('.slot-btn').forEach(b=>b.classList.toggle('selected',b.textContent.trim()===slot));
  document.getElementById('bookingFormSection').style.display = 'block';
  document.getElementById('bookingFormSection').scrollIntoView({behavior:'smooth'});
};

window.confirmBooking = async () => {
  const name  = document.getElementById('bookerName').value.trim();
  const email = document.getElementById('bookerEmail').value.trim();
  const reason= document.getElementById('bookerReason').value.trim();
  if (!name||!email)     return showToast('Please fill in name and email','error');
  if (!selectedBookingDate||!selectedBookingSlot) return showToast('Please select a date and time','error');

  const urlParams = new URLSearchParams(location.search);
  const hostUid = urlParams.get('book');

  try {
    // Save booking to Firestore
    const hostSnap = await getDoc(doc(db,'users',hostUid));
    const host = hostSnap.data();
    const duration = host?.meetingDuration || 30;
    const endH = parseInt(selectedBookingSlot.split(':')[0]);
    const endM = parseInt(selectedBookingSlot.split(':')[1]) + duration;
    const endTime = `${String(endH+Math.floor(endM/60)).padStart(2,'0')}:${String(endM%60).padStart(2,'0')}`;

    await addDoc(collection(db,'bookings'), {
      hostUid,
      hostName: host?.name || 'Host',
      bookerName: name,
      bookerEmail: email,
      reason,
      date: selectedBookingDate,
      time: selectedBookingSlot,
      endTime,
      duration,
      status: 'confirmed',
      createdAt: serverTimestamp(),
    });

    // Also add as event in host's calendar so it shows up immediately
    await addDoc(collection(db,'events'), {
      uid: hostUid,
      title: `Meeting with ${name}`,
      date: selectedBookingDate,
      start: selectedBookingSlot,
      end: endTime,
      type: 'meeting',
      color: '#6366f1',
      desc: reason || 'Booked via ChronoSync',
      location: 'ChronoSync Meeting',
      attendees: email,
      manuallyCreated: false,
      isBooking: true,
      bookerEmail: email,
      createdAt: serverTimestamp(),
    });

    document.getElementById('bookingFormSection').style.display = 'none';
    document.querySelector('.booking-layout').style.display = 'none';
    document.getElementById('bookingConfirmed').style.display = 'block';
    document.getElementById('confirmMsg').textContent = `Your meeting with ${host?.name||'the host'} on ${selectedBookingDate} at ${selectedBookingSlot} is confirmed!`;
  } catch(e) {
    console.error(e);
    showToast('Failed to book ‚Äî please try again','error');
  }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GOOGLE CALENDAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.saveGoogleConfig = async () => {
  const clientId = document.getElementById('clientIdInput').value.trim();
  const apiKey   = document.getElementById('apiKeyInput').value.trim();
  if (!clientId||!apiKey) return showToast('Please enter both Client ID and API Key','error');
  await updateDoc(doc(db,'users',currentUser.uid),{googleCalConfig:{clientId,apiKey}});
  userProfile = {...userProfile, googleCalConfig:{clientId,apiKey}};
  showToast('Credentials saved! Loading Google libraries...','success');
  loadGoogleLibraries();
};

function loadGoogleLibraries() {
  const config = userProfile?.googleCalConfig;
  if (!config?.clientId) return;
  if (typeof gapi==='undefined') {
    const s=document.createElement('script');
    s.src='https://apis.google.com/js/api.js';
    s.onload=()=>gapi.load('client',onGapiLoaded);
    document.head.appendChild(s);
  } else if(!gapiReady) { gapi.load('client',onGapiLoaded); }
  if (typeof google==='undefined'||!google.accounts) {
    const s=document.createElement('script');
    s.src='https://accounts.google.com/gsi/client';
    s.onload=onGisLoaded;
    document.head.appendChild(s);
  } else { onGisLoaded(); }
}

async function onGapiLoaded() {
  try {
    await gapi.client.init({apiKey:userProfile.googleCalConfig.apiKey,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']});
    gapiReady=true;
  } catch(e) { showToast('Google API init failed. Check API Key.','error'); }
}

function onGisLoaded() {
  try {
    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:userProfile.googleCalConfig.clientId,
      scope:GCAL_SCOPES,
      callback:onTokenResponse,
      error_callback:(e)=>showToast('Google auth error: '+(e.message||e.type||'unknown'),'error'),
    });
    gisReady=true;
    updateGCalBtn();
  } catch(e) { showToast('Google Sign-In init failed.','error'); }
}

function onTokenResponse(resp) {
  if(resp.error){showToast('Google auth failed: '+resp.error,'error');return;}
  updateDoc(doc(db,'users',currentUser.uid),{googleConnected:true});
  userProfile={...userProfile,googleConnected:true};
  updateGCalBtn();
  showToast('üéâ Google Calendar connected!','success');
  syncGoogleCalendar();
}

window.handleGoogleAuth = () => {
  if (userProfile?.googleConnected) {
    try{google.accounts.oauth2.revoke(gapi.client.getToken()?.access_token,()=>{});}catch(e){}
    try{gapi.client.setToken(null);}catch(e){}
    updateDoc(doc(db,'users',currentUser.uid),{googleConnected:false});
    userProfile={...userProfile,googleConnected:false};
    updateGCalBtn();
    showToast('Disconnected from Google Calendar','success');
    return;
  }
  if (!userProfile?.googleCalConfig?.clientId) { showView('settings'); showToast('Add your Google credentials in Settings first','error'); return; }
  loadGoogleLibraries();
  if (!gapiReady||!gisReady) {
    showToast('Loading Google libraries...','error');
    setTimeout(()=>{if(gapiReady&&gisReady)tokenClient.requestAccessToken({prompt:'consent'});else showToast('Still loading ‚Äî try again in a moment','error');},3000);
    return;
  }
  tokenClient.requestAccessToken({prompt:gapi.client.getToken()?'':'consent'});
};

function updateGCalBtn() {
  const btn=document.getElementById('gcalBtn');
  const txt=document.getElementById('gcalBtnText');
  if(!btn||!txt)return;
  const connected=userProfile?.googleConnected;
  btn.className='gcal-btn'+(connected?' connected':'');
  txt.textContent=connected?'‚úì Google Connected':'Connect Google Calendar';
}

async function syncGoogleCalendar() {
  if(!userProfile?.googleConnected||!gapiReady)return;
  const tMin=new Date();tMin.setDate(tMin.getDate()-30);
  const tMax=new Date();tMax.setFullYear(tMax.getFullYear()+1);
  try {
    const resp=await gapi.client.calendar.events.list({calendarId:'primary',timeMin:tMin.toISOString(),timeMax:tMax.toISOString(),maxResults:250,singleEvents:true,orderBy:'startTime'});
    const items=resp.result.items||[];
    // Remove old synced events
    const existingSnap=await getDocs(query(collection(db,'events'),where('uid','==',currentUser.uid),where('manuallyCreated','==',false)));
    for(const d of existingSnap.docs){if(!d.data().isBooking)await deleteDoc(d.ref);}
    // Add fresh
    for(const item of items){
      const dateStr=(item.start?.dateTime||item.start?.date||'').split('T')[0];
      await addDoc(collection(db,'events'),{
        uid:currentUser.uid,
        googleId:item.id,
        title:item.summary||'Untitled',
        date:dateStr,
        start:item.start?.dateTime?item.start.dateTime.split('T')[1].substring(0,5):'',
        end:item.end?.dateTime?item.end.dateTime.split('T')[1].substring(0,5):'',
        type:'meeting',color:'#6366f1',
        desc:item.description||'',location:item.location||'',
        attendees:(item.attendees||[]).map(a=>a.email).join(', '),
        manuallyCreated:false,
        createdAt:serverTimestamp(),
      });
    }
    showToast(`Synced ${items.length} events from Google Calendar!`,'success');
  } catch(e){showToast('Sync failed','error');console.error(e);}
}

function addToGoogleCalendar(event) {
  if(!userProfile?.googleConnected||!gapiReady)return;
  const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
  const dt=(d,t)=>t?`${d}T${t}:00`:d;
  gapi.client.calendar.events.insert({calendarId:'primary',resource:{
    summary:event.title,description:event.desc,location:event.location,
    start:event.start?{dateTime:dt(event.date,event.start),timeZone:tz}:{date:event.date},
    end:event.end?{dateTime:dt(event.date,event.end),timeZone:tz}:{date:event.date},
    attendees:event.attendees?event.attendees.split(',').map(e=>({email:e.trim()})).filter(e=>e.email):[],
  }}).then(()=>showToast('Added to Google Calendar ‚úì','success')).catch(e=>console.error(e));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UTILS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id){document.getElementById(id).classList.add('open');}
window.closeModal=(id)=>document.getElementById(id).classList.remove('open');
window.openModal=openModal;

window.toggleSidebar = () => {
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebarOverlay');
  sb.classList.toggle('mobile-open');
  ov.style.display=sb.classList.contains('mobile-open')?'block':'none';
};
window.closeSidebar = () => {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sidebarOverlay').style.display='none';
};

function showToast(msg, type='info') {
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className=`toast toast-${type}`;
  const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};
  t.innerHTML=`<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(()=>t.remove(),4000);
}
window.showToast=showToast;

function cap(s){return s?s.charAt(0).toUpperCase()+s.slice(1):'';}

function initColorPicker() {
  const colors=['#6366f1','#f472b6','#34d399','#fbbf24','#f87171','#38bdf8','#a78bfa','#fb923c'];
  const el=document.getElementById('colorPicker');
  if(!el)return;
  el.innerHTML=colors.map((c,i)=>`<div class="color-dot${i===0?' selected':''}" style="background:${c}" data-color="${c}" onclick="selectColor(this)"></div>`).join('');
}
window.selectColor=(el)=>{document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('selected'));el.classList.add('selected');};

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',(e)=>{if(e.target===o)o.classList.remove('open');}));

</script>
</body>
</html>
